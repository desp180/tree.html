<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Ёлка с подарками</title>
<style>
body { background:#0b1d2a; color:white; font-family:sans-serif; display:flex; justify-content:center; gap:20px; margin-top:20px; }
#tree { position:relative; width:400px; height:600px; }
#tree img { width:100%; }
.gift { position:absolute; width:44px; transition: transform .2s; }
.gift:hover { transform:scale(1.15); }
form { display:flex; flex-direction:column; gap:10px; width:300px; }
.gifts img { width:44px; cursor:pointer; border:2px solid transparent; border-radius:6px; }
.gifts img.selected { border-color:gold; }
</style>
</head>
<body>

<div id="tree">
  <img src="https://i.imgur.com/kX8iD8F.png" alt="Ёлка">
</div>

<form id="giftForm">
  <input id="name" type="text" placeholder="Ваше имя" required>
  <textarea id="message" rows="4" placeholder="Поздравление" required></textarea>

  <div class="gifts">
    <img src="https://i.imgur.com/Uq2ZbK3.png" data-gift="gift1">
    <img src="https://i.imgur.com/6z5HZSp.png" data-gift="gift2">
    <img src="https://i.imgur.com/gx7Z9Qq.png" data-gift="gift3">
  </div>

  <button type="submit">Отправить подарок</button>
</form>

<script>
const BIN_ID = "69163b3dd0ea881f40e6bafc"; // замените на свой Bin ID jsonbin.io
const MASTER_KEY = "$2a$10$lgEuQI8uB1Q9jbhkh8lMt.hm/w/fNOJQwhicQdi5Fi1RGkweW7L6O"; // замените на свой Master Key
const API_BASE = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

const giftsEls = document.querySelectorAll('.gifts img');
let selectedGift = null;
giftsEls.forEach(el => el.addEventListener('click', () => {
  giftsEls.forEach(i => i.classList.remove('selected'));
  el.classList.add('selected');
  selectedGift = el.dataset.gift;
}));

const tree = document.getElementById('tree');
const form = document.getElementById('giftForm');

async function fetchGifts() {
  const res = await fetch(API_BASE, {
    headers: { 'X-Master-Key': MASTER_KEY }
  });
  const json = await res.json();
  return json.record || [];
}

async function addGift(name, message, gift) {
  const current = await fetchGifts();
  current.push({name, message, gift, x: Math.random()*300+30, y: Math.random()*400+80, time: new Date().toISOString()});
  await fetch(API_BASE, {
    method:'PUT',
    headers: {
      'X-Master-Key': MASTER_KEY,
      'Content-Type':'application/json'
    },
    body: JSON.stringify({record: current})
  });
}

function renderGifts(list) {
  tree.querySelectorAll('.gift').forEach(el => el.remove());
  list.forEach(item=>{
    const imgEl = document.querySelector(`[data-gift="${item.gift}"]`);
    if(!imgEl) return;
    const img = document.createElement('img');
    img.src = imgEl.src;
    img.className = 'gift';
    img.style.left = (item.x||30)+'px';
    img.style.top = (item.y||80)+'px';
    img.title = `${item.name}: ${item.message}`;
    tree.appendChild(img);
  });
}

form.addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const message = document.getElementById('message').value.trim();
  if(!selectedGift) return alert('Выберите подарок');
  await addGift(name, message, selectedGift);
  form.reset();
  giftsEls.forEach(i=>i.classList.remove('selected'));
  selectedGift = null;
  renderGifts(await fetchGifts());
});

// начальная загрузка и автообновление каждые 6 секунд
(async function init() {
  renderGifts(await fetchGifts());
  setInterval(async()=>renderGifts(await fetchGifts()), 6000);
})();
</script>

</body>
</html>
